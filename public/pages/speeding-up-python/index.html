<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Speeding Up Python | ExampleSite</title>
<meta name=keywords content><meta name=description content="Introduction
In a recent project I ran into an issue where i was creating a ros2 node, which converts images from a camera topic converted depth image to a Point Cloud. The ML library the model is was built on is tinygrad which forces the node implementation to be in python. This forces the use of open3d python bindings for the second part of the pipeline converting the depth image to the pointcloud This normally is quite simple to do using a third party library called open3d. I had run into a lack of this dependency as in the converion from python 3.11 to 3.12 is not as straight forward for the library so it has not been realeased for python 3.12."><meta name=author content="Me"><link rel=canonical href=//localhost:1313/pages/speeding-up-python/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=//localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=//localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=//localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=//localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=//localhost:1313/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=//localhost:1313/pages/speeding-up-python/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="//localhost:1313/pages/speeding-up-python/"><meta property="og:site_name" content="ExampleSite"><meta property="og:title" content="Speeding Up Python"><meta property="og:description" content="Introduction In a recent project I ran into an issue where i was creating a ros2 node, which converts images from a camera topic converted depth image to a Point Cloud. The ML library the model is was built on is tinygrad which forces the node implementation to be in python. This forces the use of open3d python bindings for the second part of the pipeline converting the depth image to the pointcloud This normally is quite simple to do using a third party library called open3d. I had run into a lack of this dependency as in the converion from python 3.11 to 3.12 is not as straight forward for the library so it has not been realeased for python 3.12."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="pages"><meta property="article:published_time" content="2024-12-10T11:44:51-05:00"><meta property="article:modified_time" content="2024-12-10T11:44:51-05:00"><meta property="og:image" content="//localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="//localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Speeding Up Python"><meta name=twitter:description content="Introduction
In a recent project I ran into an issue where i was creating a ros2 node, which converts images from a camera topic converted depth image to a Point Cloud. The ML library the model is was built on is tinygrad which forces the node implementation to be in python. This forces the use of open3d python bindings for the second part of the pipeline converting the depth image to the pointcloud This normally is quite simple to do using a third party library called open3d. I had run into a lack of this dependency as in the converion from python 3.11 to 3.12 is not as straight forward for the library so it has not been realeased for python 3.12."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Pages","item":"//localhost:1313/pages/"},{"@type":"ListItem","position":2,"name":"Speeding Up Python","item":"//localhost:1313/pages/speeding-up-python/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Speeding Up Python","name":"Speeding Up Python","description":"Introduction In a recent project I ran into an issue where i was creating a ros2 node, which converts images from a camera topic converted depth image to a Point Cloud. The ML library the model is was built on is tinygrad which forces the node implementation to be in python. This forces the use of open3d python bindings for the second part of the pipeline converting the depth image to the pointcloud This normally is quite simple to do using a third party library called open3d. I had run into a lack of this dependency as in the converion from python 3.11 to 3.12 is not as straight forward for the library so it has not been realeased for python 3.12.\n","keywords":[],"articleBody":"Introduction In a recent project I ran into an issue where i was creating a ros2 node, which converts images from a camera topic converted depth image to a Point Cloud. The ML library the model is was built on is tinygrad which forces the node implementation to be in python. This forces the use of open3d python bindings for the second part of the pipeline converting the depth image to the pointcloud This normally is quite simple to do using a third party library called open3d. I had run into a lack of this dependency as in the converion from python 3.11 to 3.12 is not as straight forward for the library so it has not been realeased for python 3.12.\nImplementing to convert from image coordinates to world coordinates for a depth image is really simple and is goverened by the following equtions\n$$ z = d / scaling $$\n$$ x = (u - c_x) * z/fx $$\n$$ y = (v - c_y) * z/fy $$\ndef convertToPointCloud(arr:np.ndarray,cx:float,cy:float,fx:float,fy:float)-\u003enp.ndarray: height:int width:int depth_scale:float = 1000 height, width = arr.shape def indexConversion(inp, width=width,height=height): return (inp%width,inp//width) pcl_list = [] for d in range(height*width): u,v = indexConversion(d) z = -arr[v,u]/depth_scale x = ((u - cx) * z)/fx y = ((v - cy) * z)/fy pcl_list.append([x, y, z]) return np.array(pcl_list,dtype=np.float32) The above is a non vectorized implementation to convert the depth image to point cloud. This was the first implementation and when implemented I noticed a drastic slowdown in the amount of frames processed from about 70+ fps at 320,240 and we were now getting soureces of latency at around 14 fps. This is rather problematic for a system that needs to run in real-time. to improve this we can use cython a process of compiling python to code C enabling speed ups while keeping python style. This does introduce a build step to build the code.\nfrom distutils.core import setup from Cython.Build import cythonize import numpy setup( ext_modules=cythonize(\"file_with_method.pyx\",compiler_directives={\"language_level\":3}), include_dirs=[numpy.get_include()] # required to be able to use numpy arrays ) Cython is really neat as it allows you to type your python and you can compile it and easily cut processing time without actually changing the code. Then you can write it the cython way which is different a hybrid syntax that is rather clike in compared to python but runs more quickly with a little extra time. Doping this we converted using both different stylesbot of which look lke the following. Since the code is in c your able to translate over multithreading without the gil getting in the way making it easier to write multi threaded code. Their are some drawback however for really small tasks you maybe better off not using cython as their is overhead in translating the python object to a something usable in c code. If Cython is a great way to speed up numpy code as it reduces allows the code to touch python less and operate in compile land.\nimport numpy as np cimport numpy as cnp import cython cnp.import_array() # allows usage for numpy typing DTYPE = np.float32 ctypedef cnp.float32_t DTYPE_t ''' using the cython styling of code keeping some list elements''' def convertToPointCloud(cnp.ndarray arr, float cx, float cy, float fx, float fy): cdef float depth_scale = 1000.0 cdef int height = arr.shape[0] cdef int width = arr.shape[1] pcl_list:list = [] cdef float x,y,z cdef int u, v for d in range(height*width): u = d%width v = d//width z = -arr[v,u]/depth_scale x = ((\u003cfloat\u003e u - cx) * z)/fx y = ((\u003cfloat\u003e v - cy) * z)/fy pcl_list.append([x, y, z]) return np.array(pcl_list, dtype=np.float32) '''copied python code ''' def standardConvertToPointCloud(arr:np.ndarray, cx:float,cy:float,fx:float,fy:float)-\u003enp.ndarray: depth_scale:float = 1000.0 height, width = arr.shape def indexConversion(inp, width=width,height=height): return (inp%width,inp//width) pcl_list = [] for d in range(height*width): u,v = indexConversion(d) z = -arr[v,u]/depth_scale x = ((u - cx) * z)/fx y = ((v - cy) * z)/fy pcl_list.append([x, y, z]) return np.array(pcl_list,dtype=np.float32) To compare the methods we are have a base image of size240,320 we run the method on it to process the image and create the pointcloud. We use timeit package in python with repeat 100 as a This is run 100 times and each timing is recorded and averaged. then we run it through scaling the image to check how the img scales to collect the size of the image on runtime.\nmethod 1x img scale 2x scale 4x scale pure python 0.073006 .29977 1.21954 python compiled 0.051608 0.21764 0.89365 cython typing 0.030542 0.137411 0.63505 What we see in the chart is that thir are are stark difference in runtime between the Cython versions and the pure python version. we see an approximately 1/3 decrease in the runtime of the python compiled implementation and 1/2 decrease in the cython implementation. Then we notice that their is a linear growth in the runtime of pixel count and runtime for all method. This makes sense as it has all methods have O(n) runtime.\nstatic allocation and memory views The Test is ran in a similar fashion except std_deviations are given to provide insight in to differences of run time. A cchange to the code was made we use numpy to allocate an array of zeros and we change the values and return the array instead of using a list and to which is then put into an numpy array and returned.\n@cython.boundscheck(False) @cython.wraparound(False) def convertToPointCloud(cnp.ndarray arr, float cx, float cy, float fx, float fy): depth_scale:float = 1000.0 height = arr.shape[0] width = arr.shape[1] def indexConversion(inp, width=width,height=height): return (inp%width,inp//width) pcl_list = np.zeros((height*width,3), dtype=np.float32) # code change pre allocating size of returned array cdef float x, y, z cdef int u, v for d in range(height*width): u = d%width v = d//width z = -arr[v,u]/depth_scale pcl_list[d//3, 0] = = ((\u003cfloat\u003e u - cx) * z)/fx pcl_list[d//3, 1] = ((\u003cfloat\u003e v - cy) * z)/fy pcl_list[d//3, 2] = z return np.array(pcl_list,dtype=np.float32) method 1x img scale dev 2x scale dev 4x scale dev cython w/list 0.030542 .0074 0.137411 0.0093 0.63505 0.015 cython static alloc 0.030632 0.0004 0.130141 0.0044 0.56791 0.0138 What we can see is the static allocation is slower at 1x image scale but .1 ms this is most likely due to the large allocation of memory instead of going with the append. in the larger scales we see a speed up with a 5% reduction in runtime and a at the 4x image scale we see an ever decrease in runtime of about 11%. this is big at makin our code faster. This is great but we still are not as we have cut runtime down drastically by 50%. There is still more to do as we still not have unlocked true speed speed ups. Then we run into the issues we are using numpy arrays not memviews which is essentially just the raw memory. With This we can open up some we reduce the amount of code created as memory views are not a python object but a memory which can reduce processing speeds.\ndef convertToPointCloudMem(cnp.ndarray arr, float cx, float cy, float fx, float fy) -\u003e np.ndarray: cdef float[:,:] d_arr = arr cdef float depth_scale = 1000.0 cdef int height = arr.shape[0] cdef int width = arr.shape[1] cdef float[:,:] pcl_list = np.zeros((height*width,3), dtype=np.float32) cdef float x, y,z cdef int u, v, ind, x_index, y_index, z_index x_index = 0 y_index = 1 z_index = 2 for d in range(height*width): ind = d//3 u = d % width v = d // width z = -d_arr[v,u]/depth_scale pcl_list[ind, x_index] = ((\u003cfloat\u003e u - cx) * z)/fx pcl_list[ind, y_index] = ((\u003cfloat\u003e v - cy) * z)/fy pcl_list[ind, z_index] = -d_arr[v,u]/depth_scale return np.array(pcl_list,dtype=np.float32) method 1x img scale dev 2x scale dev 4x scale dev cython static alloc numpy 0.030632 0.0004 0.130141 0.0044 0.56791 0.0138 memory view implke 0.00610 0.0012 0.0228923 0.00306 0.0885817 0.00028 This is big we see a 5x to 7x runtime reduction in speed which is great, but there is more we can do duch as doing something yoiu normally can’t in python multi-threading.\nparralelizing the code In python 3.12 we lack true multithreading through the use of the GIL. But We can disable it in cython this and this can be doen with the cython.parralel which contains a lot of utils to multithread the coding but the one were gonna use is prange. with the nogil parameter set to true(dows not work unless you do in python 3.12). This allows to use the multi threaded paradigm as a way to drop runtime drastically. Outside of the this you can also use parallel class as a way to run code with nogil set To True using the parrallel class, Since this not the best method for our case we will not use it but it is another method to solve the same issue.\nfrom cython.parallel import prange @cython.cdivision(True) def convertToPointCloudMem(cnp.ndarray arr, float cx, float cy, float fx, float fy) -\u003e np.ndarray: cdef float[:,:] d_arr = arr cdef float depth_scale = 1000.0 cdef int height = \u003cint\u003e arr.shape[0] cdef int width = \u003cint\u003e arr.shape[1] cdef float[:,:] pcl_list = np.zeros((height*width,3), dtype=np.float32) cdef float z cdef Py_ssize_t d # added as this is required for using division cdef int u, v, ind cdef int x_index, y_index, z_index x_index = 0 y_index = 1 z_index = 2 for d in prange(height*width, nogil=True):# changing out range with prange from the ind = \u003cint\u003e d/3 u = \u003cint\u003e d % width v = \u003cint\u003e d / width z = -d_arr[v,u]/depth_scale pcl_list[ind, x_index] = ((\u003cfloat\u003e u - cx) * z)/fx pcl_list[ind, y_index] = ((\u003cfloat\u003e v - cy) * z)/fy pcl_list[ind, z_index] = -d_arr[v,u]/depth_scale return np.array(pcl_list,dtype=np.float32) method 1x img scale dev 2x scale dev 4x scale dev memory view 0.00610 0.0012 0.0228923 0.00306 0.0885817 0.00028 memory view parallel 0.001177 0.000075 0.0043309 0.00012 0.0126539 0.00028 we’ve gotten our code to a point where it is 73x to 100x faster through which is enought to sort our use case but their are speed ups still available such as simd. I am happy wiht this performance as i have taken my dpeth to PCL generation code from being the major computational blocker in converting a depth image to a PointCloud. This leaves more room to use a more computationaly intense model model that can reduce blocks and latency in robot operation.emote –merge run: “[[ -f package-lock.json || -f npm-shrinkwrap.json ]] \u0026\u0026 npm ci || true”\n","wordCount":"1719","inLanguage":"en","image":"//localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-12-10T11:44:51-05:00","dateModified":"2024-12-10T11:44:51-05:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"//localhost:1313/pages/speeding-up-python/"},"publisher":{"@type":"Organization","name":"ExampleSite","logo":{"@type":"ImageObject","url":"//localhost:1313/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=//localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=//localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=//localhost:1313/categories/ title=categories><span>categories</span></a></li><li><a href=//localhost:1313/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=//localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=//localhost:1313/pages/>Pages</a></div><h1 class="post-title entry-hint-parent">Speeding Up Python
<span class=entry-hint title=Draft><svg height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-meta><span title='2024-12-10 11:44:51 -0500 EST'>December 10, 2024</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;1719 words&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/pages/speeding-up-python/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h1 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h1><p>In a recent project I ran into an issue where i was creating a ros2 node, which converts images from a camera topic converted depth image to a Point Cloud. The ML library the model is was built on is tinygrad which forces the node implementation to be in python. This forces the use of open3d python bindings for the second part of the pipeline converting the depth image to the pointcloud This normally is quite simple to do using a third party library called open3d. I had run into a lack of this dependency as in the converion from python 3.11 to 3.12 is not as straight forward for the library so it has not been realeased for python 3.12.</p><p>Implementing to convert from image coordinates to world coordinates for a depth image is really simple and is goverened by the following equtions</p><p>$$ z = d / scaling $$</p><p>$$ x = (u - c_x) * z/fx $$</p><p>$$ y = (v - c_y) * z/fy $$</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>convertToPointCloud</span><span class=p>(</span><span class=n>arr</span><span class=p>:</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span><span class=n>cx</span><span class=p>:</span><span class=nb>float</span><span class=p>,</span><span class=n>cy</span><span class=p>:</span><span class=nb>float</span><span class=p>,</span><span class=n>fx</span><span class=p>:</span><span class=nb>float</span><span class=p>,</span><span class=n>fy</span><span class=p>:</span><span class=nb>float</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>height</span><span class=p>:</span><span class=nb>int</span>
</span></span><span class=line><span class=cl>  <span class=n>width</span><span class=p>:</span><span class=nb>int</span>
</span></span><span class=line><span class=cl>  <span class=n>depth_scale</span><span class=p>:</span><span class=nb>float</span> <span class=o>=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>  <span class=n>height</span><span class=p>,</span> <span class=n>width</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>indexConversion</span><span class=p>(</span><span class=n>inp</span><span class=p>,</span> <span class=n>width</span><span class=o>=</span><span class=n>width</span><span class=p>,</span><span class=n>height</span><span class=o>=</span><span class=n>height</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>inp</span><span class=o>%</span><span class=n>width</span><span class=p>,</span><span class=n>inp</span><span class=o>//</span><span class=n>width</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>pcl_list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>height</span><span class=o>*</span><span class=n>width</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>u</span><span class=p>,</span><span class=n>v</span> <span class=o>=</span> <span class=n>indexConversion</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>z</span> <span class=o>=</span> <span class=o>-</span><span class=n>arr</span><span class=p>[</span><span class=n>v</span><span class=p>,</span><span class=n>u</span><span class=p>]</span><span class=o>/</span><span class=n>depth_scale</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>((</span><span class=n>u</span> <span class=o>-</span> <span class=n>cx</span><span class=p>)</span> <span class=o>*</span> <span class=n>z</span><span class=p>)</span><span class=o>/</span><span class=n>fx</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=p>((</span><span class=n>v</span> <span class=o>-</span> <span class=n>cy</span><span class=p>)</span> <span class=o>*</span> <span class=n>z</span><span class=p>)</span><span class=o>/</span><span class=n>fy</span>
</span></span><span class=line><span class=cl>    <span class=n>pcl_list</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span><span class=p>])</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>pcl_list</span><span class=p>,</span><span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span></code></pre></div><p>The above is a non vectorized implementation to convert the depth image to point cloud. This was the first implementation and when implemented I noticed a drastic slowdown in the amount of frames processed from about 70+ fps at 320,240 and we were now getting soureces of latency at around 14 fps. This is rather problematic for a system that needs to run in real-time. to improve this we can use cython a process of compiling python to code C enabling speed ups while keeping python style. This does introduce a build step to build the code.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>distutils.core</span> <span class=kn>import</span> <span class=n>setup</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Cython.Build</span> <span class=kn>import</span> <span class=n>cythonize</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>setup</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>ext_modules</span><span class=o>=</span><span class=n>cythonize</span><span class=p>(</span><span class=s2>&#34;file_with_method.pyx&#34;</span><span class=p>,</span><span class=n>compiler_directives</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;language_level&#34;</span><span class=p>:</span><span class=mi>3</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=n>include_dirs</span><span class=o>=</span><span class=p>[</span><span class=n>numpy</span><span class=o>.</span><span class=n>get_include</span><span class=p>()]</span> <span class=c1># required to be able to use numpy arrays</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>Cython is really neat as it allows you to type your python and you can compile it and easily cut processing time without actually changing the code. Then you can write it the cython way which is different a hybrid syntax that is rather clike in compared to python but runs more quickly with a little extra time. Doping this we converted using both different stylesbot of which look lke the following. Since the code is in c your able to translate over multithreading without the gil getting in the way making it easier to write multi threaded code. Their are some drawback however for really small tasks you maybe better off not using cython as their is overhead in translating the python object to a something usable in c code. If Cython is a great way to speed up numpy code as it reduces allows the code to touch python less and operate in compile land.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=n>cimport</span> <span class=n>numpy</span> <span class=k>as</span> <span class=n>cnp</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>cython</span> 
</span></span><span class=line><span class=cl><span class=n>cnp</span><span class=o>.</span><span class=n>import_array</span><span class=p>()</span> <span class=c1># allows usage for numpy typing</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DTYPE</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span>
</span></span><span class=line><span class=cl><span class=n>ctypedef</span> <span class=n>cnp</span><span class=o>.</span><span class=n>float32_t</span> <span class=n>DTYPE_t</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39; using the cython styling of code keeping some list elements&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>convertToPointCloud</span><span class=p>(</span><span class=n>cnp</span><span class=o>.</span><span class=n>ndarray</span> <span class=n>arr</span><span class=p>,</span> <span class=nb>float</span> <span class=n>cx</span><span class=p>,</span> <span class=nb>float</span> <span class=n>cy</span><span class=p>,</span> <span class=nb>float</span> <span class=n>fx</span><span class=p>,</span> <span class=nb>float</span> <span class=n>fy</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>float</span> <span class=n>depth_scale</span> <span class=o>=</span> <span class=mf>1000.0</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>pcl_list</span><span class=p>:</span><span class=nb>list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>float</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>z</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>int</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>height</span><span class=o>*</span><span class=n>width</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>u</span> <span class=o>=</span> <span class=n>d</span><span class=o>%</span><span class=n>width</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span> <span class=o>=</span> <span class=n>d</span><span class=o>//</span><span class=n>width</span>
</span></span><span class=line><span class=cl>        <span class=n>z</span> <span class=o>=</span> <span class=o>-</span><span class=n>arr</span><span class=p>[</span><span class=n>v</span><span class=p>,</span><span class=n>u</span><span class=p>]</span><span class=o>/</span><span class=n>depth_scale</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=p>((</span><span class=o>&lt;</span><span class=nb>float</span><span class=o>&gt;</span> <span class=n>u</span> <span class=o>-</span> <span class=n>cx</span><span class=p>)</span> <span class=o>*</span> <span class=n>z</span><span class=p>)</span><span class=o>/</span><span class=n>fx</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=p>((</span><span class=o>&lt;</span><span class=nb>float</span><span class=o>&gt;</span> <span class=n>v</span> <span class=o>-</span> <span class=n>cy</span><span class=p>)</span> <span class=o>*</span> <span class=n>z</span><span class=p>)</span><span class=o>/</span><span class=n>fy</span>
</span></span><span class=line><span class=cl>        <span class=n>pcl_list</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>pcl_list</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;copied python code &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>standardConvertToPointCloud</span><span class=p>(</span><span class=n>arr</span><span class=p>:</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>cx</span><span class=p>:</span><span class=nb>float</span><span class=p>,</span><span class=n>cy</span><span class=p>:</span><span class=nb>float</span><span class=p>,</span><span class=n>fx</span><span class=p>:</span><span class=nb>float</span><span class=p>,</span><span class=n>fy</span><span class=p>:</span><span class=nb>float</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>depth_scale</span><span class=p>:</span><span class=nb>float</span> <span class=o>=</span> <span class=mf>1000.0</span>
</span></span><span class=line><span class=cl>    <span class=n>height</span><span class=p>,</span> <span class=n>width</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>indexConversion</span><span class=p>(</span><span class=n>inp</span><span class=p>,</span> <span class=n>width</span><span class=o>=</span><span class=n>width</span><span class=p>,</span><span class=n>height</span><span class=o>=</span><span class=n>height</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>inp</span><span class=o>%</span><span class=n>width</span><span class=p>,</span><span class=n>inp</span><span class=o>//</span><span class=n>width</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pcl_list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>height</span><span class=o>*</span><span class=n>width</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>u</span><span class=p>,</span><span class=n>v</span> <span class=o>=</span> <span class=n>indexConversion</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>z</span> <span class=o>=</span> <span class=o>-</span><span class=n>arr</span><span class=p>[</span><span class=n>v</span><span class=p>,</span><span class=n>u</span><span class=p>]</span><span class=o>/</span><span class=n>depth_scale</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=p>((</span><span class=n>u</span> <span class=o>-</span> <span class=n>cx</span><span class=p>)</span> <span class=o>*</span> <span class=n>z</span><span class=p>)</span><span class=o>/</span><span class=n>fx</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=p>((</span><span class=n>v</span> <span class=o>-</span> <span class=n>cy</span><span class=p>)</span> <span class=o>*</span> <span class=n>z</span><span class=p>)</span><span class=o>/</span><span class=n>fy</span>
</span></span><span class=line><span class=cl>        <span class=n>pcl_list</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>pcl_list</span><span class=p>,</span><span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span></code></pre></div><p>To compare the methods we are have a base image of size240,320 we run the method on it to process the image and create the pointcloud. We use timeit package in python with repeat 100 as a This is run 100 times and each timing is recorded and averaged. then we run it through scaling the image to check how the img scales to collect the size of the image on runtime.</p><table><thead><tr><th>method</th><th>1x img scale</th><th>2x scale</th><th>4x scale</th></tr></thead><tbody><tr><td>pure python</td><td>0.073006</td><td>.29977</td><td>1.21954</td></tr><tr><td>python compiled</td><td>0.051608</td><td>0.21764</td><td>0.89365</td></tr><tr><td>cython typing</td><td>0.030542</td><td>0.137411</td><td>0.63505</td></tr></tbody></table><p>What we see in the chart is that thir are are stark difference in runtime between the Cython versions and the pure python version. we see an approximately 1/3 decrease in the runtime of the python compiled implementation and 1/2 decrease in the cython implementation. Then we notice that their is a linear growth in the runtime of pixel count and runtime for all method. This makes sense as it has all methods have O(n) runtime.</p><h2 id=static-allocation-and-memory-views>static allocation and memory views<a hidden class=anchor aria-hidden=true href=#static-allocation-and-memory-views>#</a></h2><p>The Test is ran in a similar fashion except std_deviations are given to provide insight in to differences of run time. A cchange to the code was made we use numpy to allocate an array of zeros and we change the values and return the array instead of using a list and to which is then put into an numpy array and returned.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@cython.boundscheck</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@cython.wraparound</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>convertToPointCloud</span><span class=p>(</span><span class=n>cnp</span><span class=o>.</span><span class=n>ndarray</span> <span class=n>arr</span><span class=p>,</span> <span class=nb>float</span> <span class=n>cx</span><span class=p>,</span> <span class=nb>float</span> <span class=n>cy</span><span class=p>,</span> <span class=nb>float</span> <span class=n>fx</span><span class=p>,</span> <span class=nb>float</span> <span class=n>fy</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>depth_scale</span><span class=p>:</span><span class=nb>float</span> <span class=o>=</span> <span class=mf>1000.0</span>
</span></span><span class=line><span class=cl>    <span class=n>height</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>width</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>indexConversion</span><span class=p>(</span><span class=n>inp</span><span class=p>,</span> <span class=n>width</span><span class=o>=</span><span class=n>width</span><span class=p>,</span><span class=n>height</span><span class=o>=</span><span class=n>height</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>(</span><span class=n>inp</span><span class=o>%</span><span class=n>width</span><span class=p>,</span><span class=n>inp</span><span class=o>//</span><span class=n>width</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pcl_list</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>height</span><span class=o>*</span><span class=n>width</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span> <span class=c1># code change pre allocating size of returned array</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>float</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>int</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>height</span><span class=o>*</span><span class=n>width</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>u</span> <span class=o>=</span> <span class=n>d</span><span class=o>%</span><span class=n>width</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span> <span class=o>=</span> <span class=n>d</span><span class=o>//</span><span class=n>width</span>
</span></span><span class=line><span class=cl>        <span class=n>z</span> <span class=o>=</span> <span class=o>-</span><span class=n>arr</span><span class=p>[</span><span class=n>v</span><span class=p>,</span><span class=n>u</span><span class=p>]</span><span class=o>/</span><span class=n>depth_scale</span>
</span></span><span class=line><span class=cl>        <span class=n>pcl_list</span><span class=p>[</span><span class=n>d</span><span class=o>//</span><span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=o>=</span> <span class=p>((</span><span class=o>&lt;</span><span class=nb>float</span><span class=o>&gt;</span> <span class=n>u</span> <span class=o>-</span> <span class=n>cx</span><span class=p>)</span> <span class=o>*</span> <span class=n>z</span><span class=p>)</span><span class=o>/</span><span class=n>fx</span>
</span></span><span class=line><span class=cl>        <span class=n>pcl_list</span><span class=p>[</span><span class=n>d</span><span class=o>//</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=p>((</span><span class=o>&lt;</span><span class=nb>float</span><span class=o>&gt;</span> <span class=n>v</span> <span class=o>-</span> <span class=n>cy</span><span class=p>)</span> <span class=o>*</span> <span class=n>z</span><span class=p>)</span><span class=o>/</span><span class=n>fy</span>
</span></span><span class=line><span class=cl>        <span class=n>pcl_list</span><span class=p>[</span><span class=n>d</span><span class=o>//</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>z</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>pcl_list</span><span class=p>,</span><span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span></code></pre></div><table><thead><tr><th>method</th><th>1x img scale</th><th>dev</th><th>2x scale</th><th>dev</th><th>4x scale</th><th>dev</th></tr></thead><tbody><tr><td>cython w/list</td><td>0.030542</td><td>.0074</td><td>0.137411</td><td>0.0093</td><td>0.63505</td><td>0.015</td></tr><tr><td>cython static alloc</td><td>0.030632</td><td>0.0004</td><td>0.130141</td><td>0.0044</td><td>0.56791</td><td>0.0138</td></tr></tbody></table><p>What we can see is the static allocation is slower at 1x image scale but .1 ms this is most likely due to the large allocation of memory instead of going with the append. in the larger scales we see a speed up with a 5% reduction in runtime and a at the 4x image scale we see an ever decrease in runtime of about 11%. this is big at makin our code faster. This is great but we still are not as we have cut runtime down drastically by 50%. There is still more to do as we still not have unlocked true speed speed ups. Then we run into the issues we are using numpy arrays not memviews which is essentially just the raw memory. With This we can open up some we reduce the amount of code created as memory views are not a python object but a memory which can reduce processing speeds.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>convertToPointCloudMem</span><span class=p>(</span><span class=n>cnp</span><span class=o>.</span><span class=n>ndarray</span> <span class=n>arr</span><span class=p>,</span> <span class=nb>float</span> <span class=n>cx</span><span class=p>,</span> <span class=nb>float</span> <span class=n>cy</span><span class=p>,</span> <span class=nb>float</span> <span class=n>fx</span><span class=p>,</span> <span class=nb>float</span> <span class=n>fy</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>float</span><span class=p>[:,:]</span> <span class=n>d_arr</span> <span class=o>=</span> <span class=n>arr</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>float</span> <span class=n>depth_scale</span> <span class=o>=</span> <span class=mf>1000.0</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>float</span><span class=p>[:,:]</span> <span class=n>pcl_list</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>height</span><span class=o>*</span><span class=n>width</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>float</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span><span class=n>z</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>int</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>ind</span><span class=p>,</span> <span class=n>x_index</span><span class=p>,</span> <span class=n>y_index</span><span class=p>,</span> <span class=n>z_index</span>
</span></span><span class=line><span class=cl>    <span class=n>x_index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>y_index</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>z_index</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>height</span><span class=o>*</span><span class=n>width</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>ind</span> <span class=o>=</span> <span class=n>d</span><span class=o>//</span><span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=n>u</span> <span class=o>=</span> <span class=n>d</span> <span class=o>%</span> <span class=n>width</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span> <span class=o>=</span> <span class=n>d</span> <span class=o>//</span> <span class=n>width</span>
</span></span><span class=line><span class=cl>        <span class=n>z</span> <span class=o>=</span> <span class=o>-</span><span class=n>d_arr</span><span class=p>[</span><span class=n>v</span><span class=p>,</span><span class=n>u</span><span class=p>]</span><span class=o>/</span><span class=n>depth_scale</span>
</span></span><span class=line><span class=cl>        <span class=n>pcl_list</span><span class=p>[</span><span class=n>ind</span><span class=p>,</span> <span class=n>x_index</span><span class=p>]</span> <span class=o>=</span> <span class=p>((</span><span class=o>&lt;</span><span class=nb>float</span><span class=o>&gt;</span> <span class=n>u</span> <span class=o>-</span> <span class=n>cx</span><span class=p>)</span> <span class=o>*</span> <span class=n>z</span><span class=p>)</span><span class=o>/</span><span class=n>fx</span>
</span></span><span class=line><span class=cl>        <span class=n>pcl_list</span><span class=p>[</span><span class=n>ind</span><span class=p>,</span> <span class=n>y_index</span><span class=p>]</span> <span class=o>=</span> <span class=p>((</span><span class=o>&lt;</span><span class=nb>float</span><span class=o>&gt;</span> <span class=n>v</span> <span class=o>-</span> <span class=n>cy</span><span class=p>)</span> <span class=o>*</span> <span class=n>z</span><span class=p>)</span><span class=o>/</span><span class=n>fy</span>
</span></span><span class=line><span class=cl>        <span class=n>pcl_list</span><span class=p>[</span><span class=n>ind</span><span class=p>,</span> <span class=n>z_index</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>d_arr</span><span class=p>[</span><span class=n>v</span><span class=p>,</span><span class=n>u</span><span class=p>]</span><span class=o>/</span><span class=n>depth_scale</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>pcl_list</span><span class=p>,</span><span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span></code></pre></div><table><thead><tr><th>method</th><th>1x img scale</th><th>dev</th><th>2x scale</th><th>dev</th><th>4x scale</th><th>dev</th></tr></thead><tbody><tr><td>cython static alloc numpy</td><td>0.030632</td><td>0.0004</td><td>0.130141</td><td>0.0044</td><td>0.56791</td><td>0.0138</td></tr><tr><td>memory view implke</td><td>0.00610</td><td>0.0012</td><td>0.0228923</td><td>0.00306</td><td>0.0885817</td><td>0.00028</td></tr></tbody></table><p>This is big we see a 5x to 7x runtime reduction in speed which is great, but there is more we can do duch as doing something yoiu normally can&rsquo;t in python multi-threading.</p><h3 id=parralelizing-the-code>parralelizing the code<a hidden class=anchor aria-hidden=true href=#parralelizing-the-code>#</a></h3><p>In python 3.12 we lack true multithreading through the use of the GIL. But We can disable it in cython this and this can be doen with the cython.parralel which contains a lot of utils to multithread the coding but the one were gonna use is prange. with the nogil parameter set to true(dows not work unless you do in python 3.12). This allows to use the multi threaded paradigm as a way to drop runtime drastically. Outside of the this you can also use parallel class as a way to run code with nogil set To True using the parrallel class, Since this not the best method for our case we will not use it but it is another method to solve the same issue.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>cython.parallel</span> <span class=kn>import</span> <span class=n>prange</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@cython.cdivision</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>convertToPointCloudMem</span><span class=p>(</span><span class=n>cnp</span><span class=o>.</span><span class=n>ndarray</span> <span class=n>arr</span><span class=p>,</span> <span class=nb>float</span> <span class=n>cx</span><span class=p>,</span> <span class=nb>float</span> <span class=n>cy</span><span class=p>,</span> <span class=nb>float</span> <span class=n>fx</span><span class=p>,</span> <span class=nb>float</span> <span class=n>fy</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>float</span><span class=p>[:,:]</span> <span class=n>d_arr</span> <span class=o>=</span> <span class=n>arr</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>float</span> <span class=n>depth_scale</span> <span class=o>=</span> <span class=mf>1000.0</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>int</span> <span class=n>height</span> <span class=o>=</span> <span class=o>&lt;</span><span class=nb>int</span><span class=o>&gt;</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>int</span> <span class=n>width</span> <span class=o>=</span> <span class=o>&lt;</span><span class=nb>int</span><span class=o>&gt;</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>float</span><span class=p>[:,:]</span> <span class=n>pcl_list</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>height</span><span class=o>*</span><span class=n>width</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>float</span> <span class=n>z</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=n>Py_ssize_t</span> <span class=n>d</span> <span class=c1># added as this is required for using division</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>int</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>ind</span>
</span></span><span class=line><span class=cl>    <span class=n>cdef</span> <span class=nb>int</span> <span class=n>x_index</span><span class=p>,</span> <span class=n>y_index</span><span class=p>,</span> <span class=n>z_index</span>
</span></span><span class=line><span class=cl>    <span class=n>x_index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>y_index</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>z_index</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>prange</span><span class=p>(</span><span class=n>height</span><span class=o>*</span><span class=n>width</span><span class=p>,</span> <span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span><span class=c1># changing out range with prange from the </span>
</span></span><span class=line><span class=cl>        <span class=n>ind</span> <span class=o>=</span> <span class=o>&lt;</span><span class=nb>int</span><span class=o>&gt;</span> <span class=n>d</span><span class=o>/</span><span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=n>u</span> <span class=o>=</span> <span class=o>&lt;</span><span class=nb>int</span><span class=o>&gt;</span> <span class=n>d</span> <span class=o>%</span> <span class=n>width</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span> <span class=o>=</span> <span class=o>&lt;</span><span class=nb>int</span><span class=o>&gt;</span> <span class=n>d</span> <span class=o>/</span> <span class=n>width</span>
</span></span><span class=line><span class=cl>        <span class=n>z</span> <span class=o>=</span> <span class=o>-</span><span class=n>d_arr</span><span class=p>[</span><span class=n>v</span><span class=p>,</span><span class=n>u</span><span class=p>]</span><span class=o>/</span><span class=n>depth_scale</span>
</span></span><span class=line><span class=cl>        <span class=n>pcl_list</span><span class=p>[</span><span class=n>ind</span><span class=p>,</span> <span class=n>x_index</span><span class=p>]</span> <span class=o>=</span> <span class=p>((</span><span class=o>&lt;</span><span class=nb>float</span><span class=o>&gt;</span> <span class=n>u</span> <span class=o>-</span> <span class=n>cx</span><span class=p>)</span> <span class=o>*</span> <span class=n>z</span><span class=p>)</span><span class=o>/</span><span class=n>fx</span>
</span></span><span class=line><span class=cl>        <span class=n>pcl_list</span><span class=p>[</span><span class=n>ind</span><span class=p>,</span> <span class=n>y_index</span><span class=p>]</span> <span class=o>=</span> <span class=p>((</span><span class=o>&lt;</span><span class=nb>float</span><span class=o>&gt;</span> <span class=n>v</span> <span class=o>-</span> <span class=n>cy</span><span class=p>)</span> <span class=o>*</span> <span class=n>z</span><span class=p>)</span><span class=o>/</span><span class=n>fy</span>
</span></span><span class=line><span class=cl>        <span class=n>pcl_list</span><span class=p>[</span><span class=n>ind</span><span class=p>,</span> <span class=n>z_index</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>d_arr</span><span class=p>[</span><span class=n>v</span><span class=p>,</span><span class=n>u</span><span class=p>]</span><span class=o>/</span><span class=n>depth_scale</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>pcl_list</span><span class=p>,</span><span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span></code></pre></div><table><thead><tr><th>method</th><th>1x img scale</th><th>dev</th><th>2x scale</th><th>dev</th><th>4x scale</th><th>dev</th></tr></thead><tbody><tr><td>memory view</td><td>0.00610</td><td>0.0012</td><td>0.0228923</td><td>0.00306</td><td>0.0885817</td><td>0.00028</td></tr><tr><td>memory view parallel</td><td>0.001177</td><td>0.000075</td><td>0.0043309</td><td>0.00012</td><td>0.0126539</td><td>0.00028</td></tr></tbody></table><p>we&rsquo;ve gotten our code to a point where it is 73x to 100x faster through which is enought to sort our use case but their are speed ups still available such as simd. I am happy wiht this performance as i have taken my dpeth to PCL generation code from being the major computational blocker in converting a depth image to a PointCloud. This leaves more room to use a more computationaly intense model model that can reduce blocks and latency in robot operation.emote &ndash;merge run: &ldquo;[[ -f package-lock.json || -f npm-shrinkwrap.json ]] && npm ci || true&rdquo;</p></div><footer class=post-footer><ul class=post-tags></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Speeding Up Python on x" href="https://x.com/intent/tweet/?text=Speeding%20Up%20Python&amp;url=%2f%2flocalhost%3a1313%2fpages%2fspeeding-up-python%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Speeding Up Python on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2f%2flocalhost%3a1313%2fpages%2fspeeding-up-python%2f&amp;title=Speeding%20Up%20Python&amp;summary=Speeding%20Up%20Python&amp;source=%2f%2flocalhost%3a1313%2fpages%2fspeeding-up-python%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Speeding Up Python on reddit" href="https://reddit.com/submit?url=%2f%2flocalhost%3a1313%2fpages%2fspeeding-up-python%2f&title=Speeding%20Up%20Python"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Speeding Up Python on facebook" href="https://facebook.com/sharer/sharer.php?u=%2f%2flocalhost%3a1313%2fpages%2fspeeding-up-python%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Speeding Up Python on whatsapp" href="https://api.whatsapp.com/send?text=Speeding%20Up%20Python%20-%20%2f%2flocalhost%3a1313%2fpages%2fspeeding-up-python%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Speeding Up Python on telegram" href="https://telegram.me/share/url?text=Speeding%20Up%20Python&amp;url=%2f%2flocalhost%3a1313%2fpages%2fspeeding-up-python%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Speeding Up Python on ycombinator" href="https://news.ycombinator.com/submitlink?t=Speeding%20Up%20Python&u=%2f%2flocalhost%3a1313%2fpages%2fspeeding-up-python%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=//localhost:1313/>ExampleSite</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>